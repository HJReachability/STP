% !TEX root = ../SPP_journal.tex
%Intuitively, the number of vehicles that are affected by an intruder depends on how close the vehicles are to each other. For example, if the vehicles are in a dense configuration, then multiple vehicles might get affected by the intruder simultaneously and hence re-planning is required at a larger scale. In this section, we propose a method that guarnatee intruder avoidance while allowing vehicles to be in a dense configuration, but may require a full re-planning of the system after the intruder disappears.     
Suppose some vehicle $\veh_i$ starts avoiding the intruder $\veh_{\intr}$ at some time $t = \tsa$, and stops avoiding at $t = \tea$. When $t < \tsa$, $\veh_i$ must plan its path taking into account the possibility that it may need to avoid an intruder $\veh_i$. Since $\veh_i$ may spend a duration of up to $\iat$ performing avoidance, its induced obstacles $\ioset_k^i(t), k>i$ need to be computed in a way that reflects this possibility. The induced obstacles computation is discussed in Section \ref{sec:intruder_iocomp}.

We must also ensure that while avoiding the intruder, $\veh_i$ does not collide with the total obstacle set $\obsset_i(t)$. This requires augmenting the total obstacle set to produce the augmented total obstacle $\tilde\obsset_i(t)$; the computation of $\tilde\obsset_i(t)$ and the controller that guarantees the avoidance of the augmented obstacles are discussed in Section \ref{sec:intruder_aocomp}.

In Section \ref{sec:intruder_avoid}, we describe how $\veh_i$ can guarantee collision avoidance with the intruder.

Finally, when $t > \tea$, $\veh_i$ has already successfuly avoided the intruder, but depending on the state it ends up in while avoiding the intruder, it might need to re-plan its trajectory to reach the target safely. The re-planning process is discussed in Section \ref{sec:replan_method1}.

%\begin{itemize}
%\item \textbf{Definitions of 3 different reachable sets (2 additional reachable sets $\frs(\iat, \brs(\ldt, \targetset))$, $\brs(\bar t, \targetset)$ where $\bar t$ is the time vehicle stops avoiding intruder)}.
%\end{itemize}
%
%We are now ready to develop a general theory that takes intruders into account. Our approach to a robust path planning can be summarized in the following steps:
%\begin{itemize}
%\item \textit{Step-1}: First, we compute the set of obstacles induced by the higher priority vehicles for the lower priority vehicles.  
%\item \textit{Step-2}: We then append \textit{all} obstacles (including static ones) by a forward reachable set (FRS) of duration $\iat$. This addendum ensures that if a vehicle starts outside this appended obstacle, then it cannot collide with the obstacle in $\iat$ seconds. Next, we compute a backwards reachable set (BRS) while avoiding these obstacles till it contains the initial state of the vehicle. This set will give us the controller that ensures liveness in the absence of intruders. 
%\item \textit{Step-3}: Compute a $\iat$-step FRS of the BRS computed in Step-2. This FRS is the free flight region that allows a vehicle to avoid any intruder for $\iat$ seconds. We then compute a BRS while avoding the obstacles induced by the higher priority vehicles (computed in Step-1) \textit{and} that contains the FRS calculated in Step-3. This BRS will give us a controller that guarantee intruder avoidance and liveness. 
%\item \textit{Step-4}: Compute the relative state space wherein we can successfully avoid the intruder for $\iat$ seconds. If a vehicle sense an intruder while it is still outside this region, the above algorithm will ensure safety at all times.  
%\end{itemize}

\subsubsection{Induced Obstacle Computation \label{sec:intruder_iocomp}}
The goal of this section is to compute, for each lower priority vehicle $\veh_i$, the time-varying obstacles induced by each higher priority vehicle $\veh_j, j < i$, denoted by $\ioset_i^j(t)$. As before, the total obstacle set $\obsset_i(t)$ can then be obtained using \eqref{eq:obsseti}. 

Depending on the information known to a lower priority vehicle about $\veh_j$'s control strategy, we can use one of the three methods described in Section \ref{sec:incomp} to compute the ``base" obstacles $\boset^j(t)$ , the obstacles that would have been induced by $\veh_j$ in the absence of an intruder. The induced obstacles, $\ioset_i^j(t)$, are then given by the states a vehicle can reach while avoiding the intruder, on top of the base obstacles. Since a vehicle avoids the intruder for a maximum of $\iat$, these states can be given by the $\iat$-horizon FRS of the base obstacles. Regardless of what control is used by $\veh_j$ for avoidance, it still remains within the FRS 
\begin{equation} \label{eq:intObs}
\begin{aligned}
\ioset_i^j(t) := \frs_{\mathcal{O}, j}(t) = & \{y \in \R^{n_j}: \exists \ctrl_j(\cdot) \in \cset_j, \exists \dstb_j(\cdot) \in \dfset_j, \\
& \state_j(\cdot) \text{ satisfies \eqref{eq:dyn}}, \state_j(0) \in \boset^j(t-\iat), \\
& \state_j(\iat) = y\},
\end{aligned}
\end{equation}
which is the set of all possible states that $\veh_j$ can reach after a duration of $\iat$ starting from inside $\boset^j(t-\iat)$. The FRS can be obtained by solving the HJVI in \eqref{eq:HJIVI_FRS} with the following Hamiltonian:
\begin{equation}
\ham_{\mathcal{O}, j}(\state_j, \costate) = \max_{\ctrl_j \in \cset_j} \max_{\dstb_j \in \dset_j} \costate \cdot f_j (\state_j, \ctrl_j, \dstb_j) \label{intobs2}.
\end{equation} 
%
%Since there are no moving vehicle obstacles for the highest priority vehicle, $\obsset_1(t) = \soset$. 
%
%Computation of these base obstacles would requires information of a corresponding ``base" BRS of $\veh_j$; the process for computing this set is outlined in Step 2. In this section, we assume that the sequence of base obstacles, $\boset_i^j(t)$, is known. Given $\boset_i^j(t)$, we now show how to compute the obstacle set $\obsset_i(t)$. The induced obstacles are given by the states a vehicle can reach while avoiding the intruder, on top of the base obstacles. 

\subsubsection{Augmented Obstacle Computation \label{sec:intruder_aocomp}}
We next need to ensure that $\veh_i$ doesn't collide with the obstacle set $\obsset_i(t)$ computed in Section \ref{sec:intruder_iocomp} even when it is avoiding the intruder. This can be achieved by ensuring that $\veh_i$ is sufficently far from $\obsset_i(t)$ such that regardless of the used avoidnace control, it cannot collide with $\obsset_i(t)$. In particular, we can compute a region around the obstacles $\obsset_i(\cdot)$ such that for all disturbances, $\veh_i$ can avoid colliding with obstacles for $\iat$ seconds, if $\veh_i$ starts outside this region. Augmenting this region to $\obsset_i(\cdot)$ will give us augmented obstacles, $\tilde\obsset_i(t)$, that can then be used during the path planning of $\veh_i$ to ensure collision avoidance with $\obsset_i(t)$.  

To ensure that a vehicle does not hit the obstacle $\obsset_i(t_1 + t')$ at time $t = t_1 + t'$ starting at $t = t_1$, even when it applies any control for the next $t'$ seconds, it suffices to avoid the $t'$-horizon BRS of $\obsset_i(t_1 + t')$. This argument applies for all obstacles to appear in the next $\iat$ seconds to ensure safety under any controller and disturbance for the next $\iat$ seconds. Mathematically,

%\begin{equation} \label{eqn:inducedobs}
%\tilde\obsset_i(t) = \bigcup_{\tau \in [0, \iat]} \brs_{\mathcal{G}}(\tau, \obsset_i(t+\tau), \emptyset, \ham_{\mathcal{G}})
%\end{equation}
%where $\brs_{\mathcal{G}}(\tau, \obsset_i(t+\tau), \emptyset, \ham_{\mathcal{G}})$ represents BRS of $\obsset_i(t+\tau)$ computed backwards for $\tau$ seconds. The Hamiltonian 
%$\ham_{\mathcal{G}}$ is given by:
\begin{equation} \label{eqn:inducedobs}
\tilde\obsset_i(t) = \bigcup_{\tau \in [0, \iat]} \brs_{\mathcal{G}, i}(\tau)
\end{equation}
where $\brs_{\mathcal{G}, i}(\tau)$ represents BRS of $\obsset_i(t+\tau)$ computed backwards for $\tau$ seconds. Formally, 
\begin{equation} \label{eqn:inducedobs_help1}
\begin{aligned}
\brs_{\mathcal{G}, i}(\tau) = & \{\state_i: \exists \ctrl_i(\cdot) \in \cfset_i, \exists \dstb_i(\cdot) \in \dfset_i, \\
& \state_i(\cdot) \text{ satisfies \eqref{eq:dyn}}, \exists s \in [0, \tau], \\
& \state_i(s) \in \obsset_i(t)\}
\end{aligned}
\end{equation}

The Hamiltonian $\ham_{\mathcal{G}, i}$ to compute $\brs_{\mathcal{G}, i}(\cdot)$ is given by:
\begin{equation} \label{eqn:BRS_obsham}
\ham_{\mathcal{G}, i}(\state_i, \costate) = \min_{\ctrl_i \in \cset_i} \min_{\dstb_i \in \dset_i} \costate \cdot f_i (\state_i, \ctrl_i, \dstb_i)
\end{equation}

Finally, we compute a BRS $\brs_{\text{AO}, i}(t)$ that contains the initial state of $\veh_i$ while avoiding these augmented obstacles:
\begin{equation} \label{eqn:intrBRS1}
\begin{aligned}
\brs_{\text{AO}, i}(t) = & \{\state_i: \exists \ctrl_i(\cdot) \in \cfset_i, \forall \dstb_i(\cdot) \in \dfset_i, \\
& \state_i(\cdot) \text{ satisfies \eqref{eq:dyn}}, \forall s \in [t, \sta_i], \state_i(s) \notin \tilde\obsset_i(s), \\
& \exists s \in [t, \sta_i], \state_i(s) \in \targetset_i\}
\end{aligned}
\end{equation}
The Hamiltonian $\ham_{\text{AO}, i}$ to compute BRS in \eqref{eqn:intrBRS1} is given by:
\begin{equation*} \label{eqn:BRSham}
\ham_{\text{AO}, i}(\state_i, \costate) = \min_{\ctrl_i \in \cset_i} \max_{\dstb_i \in \dset_i} \costate \cdot f_i (\state_i, \ctrl_i, \dstb_i)
\end{equation*}

Note that $\brs_{\text{AO}, i}(\cdot)$ ensures liveness for $\veh_i$ in the absence of intruder. The liveness controller is given by:
\begin{equation}
\ctrl^*_{\text{AO}, i} = \arg \min_{\ctrl_i \in \cset_i} \max_{\dstb_i \in \dset_i} \costate \cdot f_i (\state_i, \ctrl_i, \dstb_i)
\end{equation}
Moroever, if we start within $\brs_{\text{AO}, i}$, we are guaranteed to avoid collision for $\iat$ seconds, irrespective of the control and disturbance applied. 

\subsubsection{Optimal Avoidance Controller \label{sec:intruder_avoid}}
First, we define relative coordinates of the intruder $\veh_{\intr}$ with state $\state_\intr$ with respect to $\veh_i$ with state $\state_i$.

\begin{equation}
\label{eq:reldyn}
\begin{aligned}
\state_r &= \state_\intr - \state_i \\
\dot \state_r &= f_r(\state_r, \ctrl_i, \ctrl_\intr, \dstb_i, \dstb_\intr)
\end{aligned}
\end{equation}

Given the relative dynamics, we compute the set of states from which the joint states of $\veh_{\intr}$ and $\veh_i$ can enter danger zone $\dz_{i\intr}$ despite the best efforts of $\veh_i$ to avoid $\veh_{\intr}$. Under the relative dynamics \eqref{eq:reldyn}, this set of states is given by the backwards reachable set $\brs_\text{CA}(t),~ t \in [0, \iat]$:%(\iat, \targetset_\text{CA}, \obsset_\text{CA}, H_\text{CA})$, with

\begin{equation} \label{eqn:optAvoid}
\begin{aligned}
\brs_{\text{CA}, i}(t) = & \{\state_r: \forall \ctrl_i(\cdot) \in \cfset_i, \exists \ctrl_\intr(\cdot) \in \cfset_\intr, \exists \dstb_i(\cdot) \in \dfset_i, \\
& \exists \dstb_\intr(\cdot) \in \dfset_\intr, \state_r(\cdot) \text{ satisfies \eqref{eq:reldyn}},\\
& \exists s \in [t, \iat], \state_r(s) \in \targetset_{\text{CA}, i}\}, t \geq 0, 
\end{aligned}
\end{equation}
where 
\begin{equation}
\begin{aligned}
\targetset_{\text{CA}, i} &= \{\state_r: \|\pos_r\|_2 \le \rc\} \\
H_{\text{CA}, i}(\state_r, \costate) &= \max_{\ctrl_i \in \cset_i} \min_{\ctrl_\intr \in \cset_\intr, \dstb_i \in \dset_i, \dstb_\intr \in \dset_\intr} \costate \cdot f_r(\state_r, \ctrl_i, \ctrl_\intr, \dstb_i, \dstb_\intr)
\end{aligned}
\end{equation}

Once the value function $\valfunc_{\text{CA}, i}(\cdot)$ is computed, the optimal avoidance control $\ctrl^*_{\text{CA}, i}$ can be obtained as:
\begin{equation}
\ctrl^*_{\text{CA}, i} = \arg \max_{\ctrl_i \in \cset_i} \min_{\ctrl_\intr \in \cset_\intr, \dstb_i \in \dset_i, \dstb_\intr \in \dset_\intr} \costate \cdot f_r(\state_r, \ctrl_i, \ctrl_\intr, \dstb_i, \dstb_\intr)
\end{equation}

Under normal circumstances when the intruder $\veh_{\intr}$ is far away, we have $\valfunc_{\text{CA}, i}(\iat, \state_r) > 0$; as the $\veh_{\intr}$ gets closer to $\veh_i$, $\valfunc_{\text{CA}, i}(\iat, \state_r)$ decreases. If $\veh_i$ applies the control $\ctrl^*_{\text{CA}, i}$ when $\valfunc_{\text{CA}, i}(\iat, \state_r) = 0$, then collision avoidance between $\veh_i$ and $\veh_{\intr}$ is guaranteed for a duration of $\iat$ under the worst-case intruder control strategy $\ctrl_\intr$.

In addition, obstacle augmentation ensures that $\veh_i$ will not collide with $\obsset_i(\cdot)$ during the avoidance maneuver. %Therefore, applying $\ctrl_I^A$ for a duration of $\iat$ is still guaranteed to keep $\veh_i$ safe from all obstacles, and hence safe from collision with respect to all other vehicles $\veh_j, j \neq i$.
The overall control policy for avoiding intruder and collision with other vehicles is thus given by:
\begin{equation*}
\ctrl^*_{\text{A}, i}(t) = 
\left \{ 
\begin{array}{ll}
\ctrl^*_{\text{AO}, i}(t) & t \leq \underbar{t}\\
\ctrl^*_{\text{CA}, i}(t) & \underbar{t} \leq t \leq \bar{t}
\end{array}
\right.
\end{equation*}

\subsubsection{Re-planning after intruder avoidance\label{sec:replan_method1}} 
\SBnote{Need to mention FRS for determining $\sta_i$ when replanning?}
After the intruder disappears, a liveness controller to ensure that the vehicles reach their destinations can be obtained by solving a SPP problem as described in Section \ref{sec:incomp}, where the starting states of the vehicles are now given by the states they end up in after avoiding the intruder.  
Let the optimal control policy corresponding to this liveness controller is given by $\ctrl^*_{\text{L}, i}(t)$. The overall control policy that ensures intruder avoidance, collision avoidance with other vehicles and successful transition to the destination is given by:

\begin{equation*}
\ctrl_i^*(t) = 
\left \{ 
\begin{array}{ll}
\ctrl^*_{\text{A}, i}(t) & t \leq \bar{t}\\
\ctrl^*_{\text{L}, i}(t) & t \geq \bar{t}
\end{array}
\right.
\end{equation*}

\begin{remark}
Note that we only need to re-plan the trajectories of the vehicles that are affected by the intruder. In particular, if $\valfunc_\text{CA}(\iat, \state_r) > 0$ during the entire duration of $\iat$ for a vehicle, then the vehicle need not apply any avoidance control, and hence a re-planning is not required for this vehicle. 
\end{remark}

\begin{remark}
In general, an intruder can be present in the system for much longer than $\iat$, as long as it is not affecting the SPP vehicles. $\underbar{t}$ thus really corresponds to the time an intruder starts affecting a SPP vehicle.
\end{remark}

\begin{remark}
Note that even though we have presented the analysis for one intruder, the proposed method can handle multiple intruders as long as only one intruder is present \textit{at any given time}. 
\end{remark}

We conclude this section with the overall algorithm to successfully avoid an intruder for a duration of $\iat$: 
\SBnote{Need to fix this algorithm once we fix the other issues in this method.}
\begin{alg}
\label{alg:intruder}
\textbf{Intruder Avoidance algorithm (offline-planning)}: Given initial conditions $\state_i^0$, vehicle dynamics \eqref{eq:dyn}, intruder dynamics \eqref{eq:eqn}, target set $\targetset_i$, and static obstacles $\soset_i, i = 1\ldots, \N$, for each $i$ in ascending order starting from $i=1$ (which corresponds to descending order or priority),
\begin{enumerate}
\item Determine the total obstacle set $\obsset_i(t)$, given in \eqref{eq:obsseti}. In the case $i=1$, $\obsset_i(t) = \soset_i ~ \forall t$.
\item Compute the augmented obstacle set $\tilde\obsset_i(t)$ given by \eqref{eqn:inducedobs}.
\item Given $\tilde\obsset_i(t)$, compute the BRS $\brs_{\text{AO}}(t)$ defined in \eqref{eqn}. Starting within $\brs_{\text{AO}}(t)$ enusres collision avoidnace with any other SPP vehicle for a duration of $\iat$, irrespective of the used avoidance control. 
\item The optimal avoidance control can be obtained by computing $\brs_{\text{CA}}(\iat)$ and using \eqref{eqn}. 
\item The induced obstacles $\ioset_k^i(t)$ for each $k>i$ is given by the FRS $\frs_{\mathcal{O}}(\iat)$ and can be computed using the Hamiltonian in \eqref{eqn}.
\end{enumerate}

\textbf{Intruder Avoidance algorithm (online-planning)}: Once the intruder disappears, let the states of the vehicles be $\tilde{\state}_i^0$. Given $\tilde{\state}_i^0$, vehicle dynamics \eqref{eq:dyn}, target set $\targetset_i$, and static obstacles $\soset_i, i = 1\ldots, \N$, for each $i$ in ascending order starting from $i=1$ (which corresponds to descending order or priority), use any of the three SPP methods discussed in Section \ref{sec:incomp} for re-planning. 
\end{alg}