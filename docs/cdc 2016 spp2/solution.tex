% !TEX root = SPP2.tex
\section{Solution via Double-Obstacle HJ VI and SPP\label{sec:solution}}
\subsection{Double-Obstacle Hamilton-Jacobi Variational Inequality}
\SBnote{I think we should remove this section and only keep the basic notations, like level sets, non-anticipative trajectories, BRS, and add the definition of solution trajectory.}
Our solution method takes advantage of the double-obstacle HJ variational inequality (VI) \cite{Fisac15}, in which one computes the backwards reachable set (BRS) $\brs(t)$ in the presence of a time-varying target set $\targetset(t)$ and time-varying obstacle $\obsset(t)$. Mathematically, given a system with state $z$ evolving according to

\begin{equation}
\label{eq:fdyn} % Full dynamics
\begin{aligned}
\dot{z} &= f(t, z, u, d), \quad t \in [0, T] \\
z(0) &= z_0, \quad u \in \cset, d \in \dset
\end{aligned}
\end{equation}

After defining some target set $\targetset(t)$, we compute $\brs(t)$, defined by \SBnote{Let's make the definition more traditional by interchanging the order of $u$ and $\gamma$.}
%
\begin{equation}
\label{eq:brs}
\begin{aligned}
&\brs(t) = \{z: \exists u \in \cfset, \forall \gamma[u] \in \Gamma, \eqref{eq:fdyn} \\
&\Rightarrow \exists s \in [t, T], z(s) \in \targetset(s) \wedge z(\tau) \notin \obsset(\tau) \forall \tau \in [t, s]\}
\end{aligned}
\end{equation}
%
\noindent where $\cfset$ is the set of measurable functions satisfying control constraints at every $t$, and $\Gamma$ is the set of non-anticipative strategies \cite{Mitchell05} defined as follows:
\SBnote{Let's reduce the space before equation 5. Also, it'd be helpful to add a line on the meaning of non-anticipative strategies.}
\begin{equation}
\begin{aligned}
\gamma &\in \Gamma := \{\mathcal{N}: \mathbb{U}_1 \rightarrow \mathbb{U}_2 \mid  u_1(r) = \hat{u}_1(r) \text{ a. e. } r\in[t,s] \\
& \Rightarrow \mathcal{N}[u_1](r) = \mathcal{N}[\hat{u}_1](r) \text{ a. e. } r\in[t,s]\}
\end{aligned}
\end{equation}

Informally, the BRS is the set of states from which there exists a control such that for all non-anticipative disturbances, the system is driven into the target set $\targetset(t)$ in the time horizon $[t, T]$ without first entering the obstacle set $\obsset(t)$.

Given the target set $\targetset(t)$ specified as an implicit surface function such that $\targetset(t) = \{z: l(t, z) \le 0\}$, the BRS can be obtained as the implicit surface function $V(t, z)$ such that $\brs(t) = \{z: V(t, z) \le 0\}$, where $V(t, z)$ is the viscosity solution \cite{Crandall83} to the following HJ VI:
%
\begin{equation}
\label{eq:HJIVI}
\begin{aligned}
\max\Big\{&\min\big\{D_t V(t, z) + H\left(t, z, D_z V\right), l(t,z) - V(t, z)\big\}\\
& -g(t, z) - V(t, z)\Big\} = 0, \quad t\in[0,T]\\
&V(T, z) = \max\big\{l(T, z), -g(T, z)\big\} \\ 
&H\left(t, z, p\right) = \min_{u \in \cset} \max_{d \in \dset} p \cdot f(t, z, u, d)
\end{aligned}
\end{equation}
%
\noindent where $g(t, z)$ is the implicit surface function representing obstacle, $\obsset(t)$: $\obsset(t) = \{z: g(t, z) \le 0\}$. After the BRS is computed, the optimal control can be obtained as follows:
%
\begin{equation}
\label{eq:opt_ctrl}
u^*(t, z) = \arg \min_{u \in \cset} \max_{d \in \dset} H\left(t, z, D_z V\right)
\end{equation}

In theory, one could define the state to be the joint states of all vehicles, $z = (x_1, x_2, \ldots, x_N)$, define the dynamics \eqref{eq:fdyn} to follow $\eqref{eq:dyn}$, the target set $\targetset$ to correspond to the situation in which all vehicles have arrived at their targets $\targetset_i, i = 1, \ldots, N$, and the obstacle set $\obsset$ to correspond to the combination of all the danger zones $\dz_{ij}$. Then, \eqref{eq:HJIVI} could be solved to obtain $\brs(t)$, and then the joint optimal control would be given by \eqref{eq:opt_ctrl}.

However, practically, the dimensionality of the joint state $z$ would be extremely high. In fact, for even the simplest vehicle models, solving \eqref{eq:HJIVI} would be intractable for more than two vehicles. Therefore, we propose \SBnote{I think use will be a better word than propose here. We are not proposing SPP; you have already done it earlier.} the sequential path planning method, which allows \eqref{eq:HJIVI} to be solved in the state space of each vehicle, making the computation complexity scale linearly, as opposed to exponentially, with the number of vehicles.

\subsection{Sequential Path Planning}
In order to make the $N$-vehicle path planning problem safe and tractable, we impose a reasonable structure to the problem: each vehicle is assigned a strict priority ordering. When planning its trajectory to its target, a higher-priority vehicle can disregard the presence of a lower priority vehicle. In contrast, a lower priority vehicle must take into account the presence of all higher priority vehicles, and plan its trajectory in a way that avoids the higher priority vehicles' danger zones. For convenience and without lost of generality, let vehicle $i$ have the $i$th highest priority and denote it as $\veh_i$.

Optimal path planning in this setting is enabled by a HJ VI which computes the BRS $\brs_i(t)$ from a target set $\targetset_i$ in the presence of time-varying obstacles $\obsset_i(t)$. In the sequential path planning application, the time-varying obstacles represent regions of the state space of $\veh_i$ that must be avoided in order to ensure that $\veh_i$ does not enter any danger zones of higher priority vehicles. We present three different ways to compute $\obsset_i$, obstacles induced by higher priority vehicles in Section \ref{sec:obs_gen}. For now, we proceed assuming $\obsset_i$ is given.

To obtain the optimal control for reaching the target we adapt \eqref{eq:HJIVI} to $\veh_i$ and solve the following HJ VI:
\SBnote{Do we really need to write these equations again? They are only slightly different from equation 6.}
%
\begin{equation}
\label{eq:HJIVI_i}
\begin{aligned}
\max\Big\{&\min\big\{D_t V_i(t, x_i) + H_i\left(t, x_i, D_{x_i} V\right),\\
& l_i(t, x_i) - V_i(t, x_i)\big\}, -g_i(t, x_i) - V_i(t, x_i)\Big\} = 0, \\
& t \in [\edt, \sta]\\
&V_i(\sta, x_i) = \max\big\{l_i(x_i), -g_i(\sta, x_i)\big\} \\
&H_i\left(t, x_i, p\right) = \min_{u_i \in \cset_i} \max_{d_i \in \dset_i} p \cdot f(t, x_i, u_i, d_i)
\end{aligned}
\end{equation}

Here, the target set $\targetset_i$, obstacle set $\obsset_i(t)$, and BRS $\brs_i(t)$ are related to $l_i(x_i), g_i(t, x_i), V_i(t, x_i)$ as follows:
%
\begin{equation}
\begin{aligned}
\targetset_i &= \{x_i: l_i(x_i) \le 0\} \\
\obsset_i(t) &= \{x_i: g_i(t, x_i) \le 0\} \\
\brs_i(t) &= \{x_i: V_i(t, x_i) \le 0\}
\end{aligned}
\end{equation}

From the BRS, the optimal control for vehicle $\veh_i$ is then given as
\SBnote{The equation below doesn't seem correct. $H$ is already optimized at this point. We should either use the un-optimized $H$ below or write it in a similar fashion to equation 7.}
\begin{equation}
\label{eq:opt_ctrl_i}
u_i^*(t, x_i) = \arg \min_{u_i \in \cset_i} H_i\left(t, x_i, D_{x_i} V_i\right)
\end{equation}

If $\veh_i$ uses the optimal control given by \eqref{eq:opt_ctrl_i}, then $\veh_i$ can be guaranteed to reach the target $\targetset_i$ as long as $\veh_i$ departs by the latest departure time $\ldt_i$, defined as $\inf_t V_i(t, x_i) \le 0$. \SBnote{Shouldn't it be $\sup_t V_i(t, x_i^o) \leq 0$?}  